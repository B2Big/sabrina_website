// prisma/schema.prisma
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Service {
  id            String   @id @default(cuid())
  category      String   // "Coaching", "Massages", "Cures"
  title         String
  description   String
  price         String
  originalPrice String?  @map("originalprice")
  duration      String?
  objective     String?
  popular       Boolean  @default(false)
  bestValue     Boolean  @default(false) @map("bestvalue")
  note          String?
  features      String[]
  paymentLink   String?  @map("paymentlink")

  promotions    Promotion[]

  createdAt     DateTime @default(now()) @map("createdat")
  updatedAt     DateTime @updatedAt @map("updatedat")

  @@map("services")
}

model Promotion {
  id        String   @id @default(cuid())
  text      String?
  link      String?

  discountPercent Int? @map("discountpercent")
  services        Service[]

  isActive  Boolean  @default(true) @map("isactive")
  startDate DateTime? @map("startdate")
  endDate   DateTime? @map("enddate")
  createdAt DateTime @default(now()) @map("createdat")

  @@map("promotions")
}

enum OrderStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Order {
  id               String      @id @default(cuid())
  stripeSessionId  String      @unique @map("stripe_session_id")
  stripePaymentId  String?     @map("stripe_payment_id")

  amount           Float       // Montant en euros
  currency         String      @default("eur")
  status           OrderStatus @default(PENDING)

  customerEmail    String      @map("customer_email")
  customerName     String?     @map("customer_name")

  serviceIds       String[]    @map("service_ids")
  itemCount        Int         @map("item_count")

  paidAt           DateTime?   @map("paid_at")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  @@index([customerEmail])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model NewsletterSubscriber {
  id                String    @id @default(cuid())
  email             String    @unique
  name              String?

  // Source d'inscription
  source            String    @default("checkout") // "checkout", "footer", "popup"

  // Statut
  isSubscribed      Boolean   @default(true) @map("is_subscribed")
  unsubscribeToken  String    @unique @default(cuid()) @map("unsubscribe_token")

  // Dates
  subscribedAt      DateTime  @default(now()) @map("subscribed_at")
  unsubscribedAt    DateTime? @map("unsubscribed_at")

  // RGPD
  consentGiven      Boolean   @default(true) @map("consent_given")
  ipAddress         String?   @map("ip_address")

  @@index([email])
  @@index([isSubscribed])
  @@map("newsletter_subscribers")
}

// ============================================
// SYSTÈME DE RÉSERVATION AVEC EMAILS RESEND
// ============================================

enum ReservationStatus {
  attente_paiement_sur_place
  paye_confirme
  annule
  termine
}

model Reservation {
  id                String            @id @default(cuid())
  status            ReservationStatus @default(attente_paiement_sur_place)
  
  // Client
  customerName      String            @map("customer_name")
  customerEmail     String            @map("customer_email")
  customerPhone     String            @map("customer_phone")
  message           String?
  
  // Service
  serviceTitle      String            @map("service_title")
  servicePrice      Float             @map("service_price")
  serviceDuration   String?           @map("service_duration")
  quantity          Int               @default(1)
  totalAmount       Float             @map("total_amount")
  
  // Paiement
  paymentMethod     String            @map("payment_method") // "sur_place" | "stripe"
  stripeSessionId   String?           @unique @map("stripe_session_id")
  stripePaymentId   String?           @map("stripe_payment_id")
  paidAt            DateTime?         @map("paid_at")
  
  // Dates
  requestedDate     DateTime?         @map("requested_date") // Date souhaitée (si fournie)
  confirmedDate     DateTime?         @map("confirmed_date") // Date confirmée par Sabrina
  
  // Timestamps
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  @@index([status])
  @@index([customerEmail])
  @@index([createdAt])
  @@map("reservations")
}

// ============================================
// AUDIT TRAIL - LOGS DES ACTIONS ADMIN
// ============================================

model AdminLog {
  id          String   @id @default(cuid())
  
  // Utilisateur qui a fait l'action
  userId      String   @map("user_id")
  userEmail   String   @map("user_email")
  
  // Action effectuée
  action      String   // Ex: CREATE_SERVICE, DELETE_PROMOTION, etc.
  entityType  String   @map("entity_type") // Ex: Service, Promotion, etc.
  entityId    String?  @map("entity_id")   // ID de l'entité concernée
  
  // Détails (JSON)
  details     String?  // JSON stringifié avec les détails
  
  // Métadonnées requête
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  
  // Timestamp
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_logs")
}