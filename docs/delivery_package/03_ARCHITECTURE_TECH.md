# üèóÔ∏è Architecture Technique - Sab-Fit
## Documentation Technique Compl√®te

---

## Stack Technique

### Vue d'Ensemble

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                           SAB-FIT PLATFORM                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   üåê FRONTEND WEB                                                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   Next.js 16 (React 19)                                              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   Tailwind CSS 4                                                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   PWA (Progressive Web App)                                          ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                              ‚îÇ                                               ‚îÇ
‚îÇ                              ‚îÇ API / Server Actions                          ‚îÇ
‚îÇ                              ‚ñº                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   ‚öôÔ∏è BACKEND / BaaS                                                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   Supabase (PostgreSQL + Auth)                                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   Prisma ORM                                                          ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                              ‚îÇ                                               ‚îÇ
‚îÇ           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
‚îÇ           ‚îÇ                  ‚îÇ                  ‚îÇ                           ‚îÇ
‚îÇ           ‚ñº                  ‚ñº                  ‚ñº                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ  ‚îÇ   üí≥ STRIPE ‚îÇ    ‚îÇ   üìß RESEND  ‚îÇ    ‚îÇ   üåê NETLIFY ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ   Paiement  ‚îÇ    ‚îÇ   Emails     ‚îÇ    ‚îÇ   Hosting    ‚îÇ                   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ
‚îÇ                                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Technologies D√©taill√©es

#### Frontend Web
| Technologie | Version | R√¥le |
|-------------|---------|------|
| Next.js | 16.1.3 | Framework React avec App Router |
| React | 19.2.3 | UI Library |
| TypeScript | 5.x | Typage statique |
| Tailwind CSS | 4.x | Styling utility-first |
| Framer Motion | 12.x | Animations |
| Zod | 4.x | Validation sch√©mas |

#### Backend & Database
| Technologie | Version | R√¥le |
|-------------|---------|------|
| Supabase | - | BaaS (Backend as a Service) |
| PostgreSQL | 15+ | Base de donn√©es relationnelle |
| Prisma | 5.22 | ORM (Object-Relational Mapping) |
| Supabase Auth | - | Authentification |
| Row Level Security | - | S√©curit√© base de donn√©es |

#### Services Externes
| Service | Usage |
|---------|-------|
| Stripe | Paiements en ligne (carte, PayPal) |
| Resend | Envoi d'emails transactionnels |
| Netlify | H√©bergement et CI/CD |

---

## Architecture D√©taill√©e

### Diagramme d'Architecture

```mermaid
flowchart TB
    subgraph CLIENT["üë§ CLIENT"]
        direction TB
        WEB["üåê Site Web\nNext.js + React"]
        MOBILE["üì± PWA Mobile\n(Installable)"]
    end

    subgraph EDGE["üåê EDGE / CDN"]
        NETLIFY["Netlify\nSSL + CDN"]
    end

    subgraph SERVER["‚öôÔ∏è SERVEUR"]
        direction TB
        NEXT["Next.js Server\nServer Actions\nAPI Routes"]
        
        subgraph MIDDLEWARE["üõ°Ô∏è Middleware"]
            AUTH["Auth Supabase"]
            RATE["Rate Limiting"]
            VALID["Validation Zod"]
        end
    end

    subgraph DATABASE["üóÑÔ∏è DATABASE LAYER"]
        direction TB
        SUPABASE["Supabase"]
        
        subgraph RLS["Row Level Security"]
            POLICIES["Policies\n- services: public read\n- admin: write\n- reservations: owner only"]
        end
        
        POSTGRES[("PostgreSQL")]
    end

    subgraph SERVICES["üîå SERVICES EXTERNES"]
        STRIPE["üí≥ Stripe\nCheckout + Webhooks"]
        RESEND["üìß Resend\nEmails"]
    end

    WEB --> NETLIFY
    MOBILE -.->|"PWA Cache"| WEB
    NETLIFY --> NEXT
    
    NEXT --> MIDDLEWARE
    MIDDLEWARE --> SUPABASE
    
    SUPABASE --> RLS
    RLS --> POSTGRES
    
    NEXT -->|"Payment"| STRIPE
    STRIPE -->|"Webhook"| NEXT
    NEXT -->|"Send Email"| RESEND

    style WEB fill:#3B82F6,color:#fff
    style POSTGRES fill:#10B981,color:#fff
    style STRIPE fill:#635BFF,color:#fff
```

### Flux de Donn√©es

```mermaid
sequenceDiagram
    participant C as Client
    participant N as Next.js
    participant S as Supabase
    participant St as Stripe
    participant R as Resend

    Note over C,R: Sc√©nario: R√©servation avec paiement

    C->>N: 1. Ajoute service au panier
    N->>C: Affiche panier flottant

    C->>N: 2. Soumet formulaire + choix "Payer en ligne"
    N->>S: 3. Cr√©e r√©servation (statut: attente)
    S-->>N: ID r√©servation

    N->>St: 4. Cr√©e session checkout
    St-->>N: URL checkout
    N-->>C: 5. Redirection Stripe

    C->>St: 6. Saisie carte + paiement
    St->>N: 7. Webhook: checkout.session.completed

    N->>S: 8. Met √† jour r√©servation (statut: pay√©)
    N->>R: 9a. Email confirmation client
    N->>R: 9b. Email notification admin
    
    St-->>C: 10. Redirection page succ√®s
```

---

## Sch√©ma de Base de Donn√©es (ERD)

### Diagramme Entit√©-Relation

```mermaid
erDiagram
    SERVICE ||--o{ PROMOTION : "peut avoir"
    SERVICE ||--o{ RESERVATION : "concerne"
    RESERVATION ||--|| ORDER : "peut g√©n√©rer"
    CUSTOMER ||--o{ RESERVATION : "passe"
    CUSTOMER ||--o{ NEWSLETTER_SUBSCRIBER : "peut s'abonner"
    
    SERVICE {
        string id PK
        string category
        string title
        string description
        string price
        string originalPrice
        string duration
        boolean popular
        boolean bestValue
        string[] features
        datetime createdAt
        datetime updatedAt
    }
    
    PROMOTION {
        string id PK
        string text
        int discountPercent
        boolean isActive
        datetime startDate
        datetime endDate
        datetime createdAt
    }
    
    RESERVATION {
        string id PK
        enum status
        string customerName
        string customerEmail
        string customerPhone
        string message
        string serviceTitle
        float servicePrice
        int quantity
        float totalAmount
        string paymentMethod
        string stripeSessionId UK
        string stripePaymentId
        datetime paidAt
        datetime requestedDate
        datetime createdAt
        datetime updatedAt
    }
    
    ORDER {
        string id PK
        string stripeSessionId UK
        string stripePaymentId
        float amount
        string currency
        enum status
        string customerEmail
        string customerName
        string[] serviceIds
        int itemCount
        datetime paidAt
        datetime createdAt
    }
    
    NEWSLETTER_SUBSCRIBER {
        string id PK
        string email UK
        string name
        string source
        boolean isSubscribed
        string unsubscribeToken UK
        datetime subscribedAt
        datetime unsubscribedAt
        boolean consentGiven
        datetime createdAt
    }
    
    CUSTOMER {
        string id PK
        string email UK
        string name
        string phone
        datetime createdAt
    }
```

### Mod√®les D√©taill√©s

#### 1. Service (Prestations)
```typescript
interface Service {
  id: string;              // CUID unique
  category: string;        // "Coaching", "Massages", "Cures"
  title: string;           // Nom du service
  description: string;     // Description longue
  price: string;           // Format: "70 ‚Ç¨"
  originalPrice?: string;  // Prix barr√© (promo)
  duration?: string;       // "60 min"
  popular: boolean;        // Badge "Populaire"
  bestValue: boolean;      // Badge "Meilleur rapport"
  features: string[];      // Liste des avantages
  createdAt: Date;
  updatedAt: Date;
}
```

#### 2. Reservation (R√©servations)
```typescript
enum ReservationStatus {
  'attente_paiement_sur_place',  // Cr√©√©e, paiement √† venir
  'paye_confirme',                // Pay√©e (Stripe ou confirm√©)
  'annule',                       // Annul√©e
  'termine'                       // Service rendu
}

interface Reservation {
  id: string;
  status: ReservationStatus;
  
  // Client
  customerName: string;
  customerEmail: string;
  customerPhone: string;
  message?: string;
  
  // Service (d√©normalis√© pour historique)
  serviceTitle: string;
  servicePrice: number;
  quantity: number;
  totalAmount: number;
  
  // Paiement
  paymentMethod: 'sur_place' | 'stripe';
  stripeSessionId?: string;  // Lien avec Stripe
  stripePaymentId?: string;  // ID transaction
  paidAt?: Date;
  
  // Planning
  requestedDate?: Date;      // Date souhait√©e
  confirmedDate?: Date;      // Date confirm√©e par Sabrina
  
  createdAt: Date;
  updatedAt: Date;
}
```

#### 3. Promotion (Offres sp√©ciales)
```typescript
interface Promotion {
  id: string;
  text?: string;              // Texte de la promo
  discountPercent?: number;   // % de r√©duction
  services: Service[];        // Services concern√©s
  isActive: boolean;
  startDate?: Date;
  endDate?: Date;
  createdAt: Date;
}
```

---

## PWA (Progressive Web App)

### Configuration

Le site est configur√© comme une PWA via `@ducanh2912/next-pwa` :

```javascript
// next.config.js (simplifi√©)
const withPWA = require('@ducanh2912/next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  disable: process.env.NODE_ENV === 'development'
});
```

### Fichiers PWA

```
public/
‚îú‚îÄ‚îÄ manifest.json          # Configuration PWA
‚îú‚îÄ‚îÄ sw.js                  # Service Worker (auto-g√©n√©r√©)
‚îî‚îÄ‚îÄ icons/
    ‚îú‚îÄ‚îÄ icon-192x192.png   # Ic√¥ne Android
    ‚îú‚îÄ‚îÄ icon-512x512.png   # Ic√¥ne iOS/Splash
    ‚îî‚îÄ‚îÄ apple-touch-icon.png
```

### Manifest.json

```json
{
  "name": "Sab-Fit",
  "short_name": "Sab-Fit",
  "description": "Coaching & Bien-√™tre - Pop & Wellness",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#0F172A",
  "theme_color": "#3B82F6",
  "icons": [
    { "src": "/icons/icon-192x192.png", "sizes": "192x192" },
    { "src": "/icons/icon-512x512.png", "sizes": "512x512" }
  ]
}
```

### Capacit√©s PWA

| Fonctionnalit√© | Statut | Description |
|----------------|--------|-------------|
| **Installable** | ‚úÖ | Ajout √† l'√©cran d'accueil |
| **Hors-ligne** | ‚úÖ | Cache des pages visit√©es |
| **R√©activit√©** | ‚úÖ | < 3s temps de chargement |
| **Push** | ‚è≥ | Notifications (Phase 2) |

---

## S√©curit√©

### Authentification (Supabase Auth)

```mermaid
flowchart LR
    A[Login Page] --> B{Credentials}
    B -->|Valid| C[JWT Token]
    B -->|Invalid| D[Error]
    C --> E[Middleware Check]
    E -->|Token OK| F[Admin Dashboard]
    E -->|Token Expired| G[Redirect Login]
```

### Row Level Security (RLS)

```sql
-- Exemple de policies RLS

-- Services: Lecture publique, √©criture admin
ALTER TABLE services ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Services visibles par tous" ON services
  FOR SELECT USING (true);

CREATE POLICY "Services modifiables par admin" ON services
  FOR ALL USING (
    auth.role() = 'authenticated' AND 
    auth.jwt() ->> 'role' IN ('ADMIN', 'DEVELOPER')
  );

-- R√©servations: Accessible uniquement par l'admin (via serveur)
ALTER TABLE reservations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "R√©servations accessibles service_role" ON reservations
  FOR ALL USING (auth.role() = 'service_role');
```

---

## D√©ploiement

### Pipeline CI/CD (Netlify)

```mermaid
flowchart LR
    A[Developer] -->|git push| B[GitHub]
    B -->|Webhook| C[Netlify Build]
    C --> D[npm install]
    D --> E[prisma generate]
    E --> F[next build]
    F -->|Success| G[Deploy to CDN]
    F -->|Failure| H[Alert]
```

### Variables d'Environnement Requises

```bash
# Database
DATABASE_URL=postgresql://...
DIRECT_URL=postgresql://...

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://...
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...

# Stripe
STRIPE_SECRET_KEY=sk_live_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Email
RESEND_API_KEY=re_...

# App
NEXT_PUBLIC_URL=https://www.sab-fit.com
```

---

*Architecture Technique - Version 1.0*
